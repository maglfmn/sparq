{% extends "base.html" %}

{% block title %}Weather{% endblock %}

{% block app_class %}weather-app{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('weather_bp.static', filename='css/weather.css') }}">
{% endblock %}

{% block content %}
<div class="content-card weather-card">
    <div class="weather-search">
        <input type="text" id="cityInput" class="form-control" placeholder="Enter city name..." value="Minneapolis">
        <button id="searchBtn" class="btn btn-primary">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div id="weatherResult" class="weather-result">
        <!-- Initial state / placeholder -->
        <div class="weather-placeholder">
            <i class="fas fa-cloud-sun-rain"></i>
            <p>Enter a city to see the weather</p>
        </div>

        <!-- Loading state (hidden by default) -->
        <div class="weather-loading" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i>
            </div>
            <p>Loading weather data...</p>
        </div>

        <!-- Weather data (hidden by default) -->
        <div class="weather-data" style="display: none;">
            <div class="weather-main">
                <i class="weather-icon"></i>
                <div class="weather-temp"></div>
            </div>
            <div class="weather-info">
                <div class="weather-description"></div>
                <div class="weather-details">
                    <div>Humidity: <span class="humidity"></span>%</div>
                </div>
            </div>
        </div>

        <!-- Error state (hidden by default) -->
        <div class="weather-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <p>City not found. Please try again.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cityInput = document.getElementById('cityInput');
    const searchBtn = document.getElementById('searchBtn');
    const weatherResult = document.getElementById('weatherResult');
    
    function showLoading() {
        weatherResult.querySelector('.weather-placeholder').style.display = 'none';
        weatherResult.querySelector('.weather-loading').style.display = 'flex';
        weatherResult.querySelector('.weather-data').style.display = 'none';
        weatherResult.querySelector('.weather-error').style.display = 'none';
    }
    
    function showError() {
        weatherResult.querySelector('.weather-placeholder').style.display = 'none';
        weatherResult.querySelector('.weather-loading').style.display = 'none';
        weatherResult.querySelector('.weather-data').style.display = 'none';
        weatherResult.querySelector('.weather-error').style.display = 'flex';
    }
    
    function showWeather(data) {
        const weatherData = weatherResult.querySelector('.weather-data');
        weatherData.querySelector('.weather-icon').className = `weather-icon fas ${getWeatherIcon(data.icon)}`;
        weatherData.querySelector('.weather-temp').textContent = `${data.temperature}Â°F`;
        weatherData.querySelector('.weather-description').textContent = data.description;
        weatherData.querySelector('.humidity').textContent = data.humidity;
        weatherData.querySelector('.weather-details').innerHTML = `
            <div>Humidity: <span class="humidity">${data.humidity}</span>%</div>
        `;
        
        weatherResult.querySelector('.weather-placeholder').style.display = 'none';
        weatherResult.querySelector('.weather-loading').style.display = 'none';
        weatherResult.querySelector('.weather-error').style.display = 'none';
        weatherData.style.display = 'block';
    }
    
    function getWeatherIcon(code) {
        const icons = {
            '01d': 'fa-sun',
            '01n': 'fa-moon',
            '02d': 'fa-cloud-sun',
            '02n': 'fa-cloud-moon',
            '03d': 'fa-cloud',
            '03n': 'fa-cloud',
            '04d': 'fa-cloud',
            '04n': 'fa-cloud',
            '09d': 'fa-cloud-rain',
            '09n': 'fa-cloud-rain',
            '10d': 'fa-cloud-sun-rain',
            '10n': 'fa-cloud-moon-rain',
            '11d': 'fa-bolt',
            '11n': 'fa-bolt',
            '13d': 'fa-snowflake',
            '13n': 'fa-snowflake',
            '50d': 'fa-smog',
            '50n': 'fa-smog'
        };
        return icons[code] || 'fa-cloud';
    }
    
    function searchWeather() {
        const city = cityInput.value.trim();
        if (!city) return;
        
        console.log('Searching weather for:', city); // Debug line
        showLoading();
        
        fetch('/weather/lookup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ city: city })
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug line
            return response.json();
        })
        .then(data => {
            console.log('Weather data:', data); // Debug line
            if (data.error) {
                showError();
            } else {
                showWeather(data);
            }
        })
        .catch(error => {
            console.error('Weather fetch error:', error); // Debug line
            showError();
        });
    }
    
    // Load Minneapolis weather on page load
    setTimeout(searchWeather, 100); // Small delay to ensure DOM is ready
    
    searchBtn.addEventListener('click', searchWeather);
    cityInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchWeather();
    });
});
</script>
{% endblock %} 